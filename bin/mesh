#!/usr/bin/env node

var meshcli = require('../lib/mesh'),
	fs = require('fs'),
	path = require('path'),
	program = require('commander'),
	out = require('out');
	
function progInit() {
	program.usage('[options] action (default action = update)');
	program.option('-p, --path [path]', 'Target output path (default to current directory)');
	program.option(',--couchurl [couchurl]', 'CouchDB url (default: http://localhost:5984/)');
	program.option(',--user [user]', 'CouchDB username for BasicAuth (default: none)');
	program.option(',--pass [pass]', 'CouchDB password for BasicAuth (default: none)');
	program.option(',--appid [appid]', 'The id of the application (default: top level dir for path)');
	program.option(',--meshdb [meshdb]', 'The steelmesh application database that this will be published to. (default: steelmesh)');
	program.parse(process.argv);
	
	meshcli.init(program, function(err, mesh) {
		if (! err) {
			// determine the greenslide action to run
			var action = mesh.getAction(program.args);
			
			if (action && action.call) {
				out(':: !{yellow}{0}', program.args);
				
				// run the action
				action.call(mesh, program, function(err, results) {
					if (err) {
						out('!{red}' + err);
					}
					else {
						if (results && typeof results.length != 'undefined') {
							if (results.length == 0) {
								out(':: no results');
							} // if
						
							results.forEach(function(line) {
								out(':: ' + line);
							});
						}
					
						// out('!{green}Operation succcessful');
					}
				});
			}
			else {
				out('Unable to run action: !{underline}{0}', program.args);
			} // if..else
		}
		else {
			console.error(err);
		}
	});
} // progInit
	
fs.readFile(path.join(__dirname, '../package.json'), 'utf8', function(err, contents) {
	if (! err) {
		var packageData = JSON.parse(contents);
		
		program.version(packageData.version);
	} // if

	progInit();
});